<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Parallel execution of a function on the Slurm cluster — slurm_apply • rslurm</title>


<!-- jquery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<!-- Bootstrap -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/darkly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous" />


<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script>

<!-- bootstrap-toc -->
<link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script>

<!-- Font Awesome icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous" />

<!-- clipboard.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script>

<!-- headroom.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script>

<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script>



  <link href="../extra.css" rel="stylesheet">
  

<meta property="og:title" content="Parallel execution of a function on the Slurm cluster — slurm_apply" />
<meta property="og:description" content="Use slurm_apply to compute function over multiple sets of
parameters in parallel, spread across multiple nodes of a Slurm cluster,
with similar syntax to mapply." />




<!-- mathjax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->



  </head>

  <body data-spy="scroll" data-target="#toc">
    <div class="container template-reference-topic">
      <header>
      <div class="navbar navbar-standard navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">rslurm</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.5.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/rslurm.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/SESYNC-ci/rslurm/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
      
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header>

<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Parallel execution of a function on the Slurm cluster</h1>
    <small class="dont-index">Source: <a href='https://github.com/SESYNC-ci/rslurm/blob/master/R/slurm_apply.R'><code>R/slurm_apply.R</code></a></small>
    <div class="hidden name"><code>slurm_apply.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>Use <code>slurm_apply</code> to compute function over multiple sets of
parameters in parallel, spread across multiple nodes of a Slurm cluster,
with similar syntax to <code>mapply</code>.</p>
    </div>

    <pre class="usage"><span class='fu'>slurm_apply</span>(
  <span class='no'>f</span>,
  <span class='no'>params</span>,
  <span class='no'>...</span>,
  <span class='kw'>jobname</span> <span class='kw'>=</span> <span class='fl'>NA</span>,
  <span class='kw'>nodes</span> <span class='kw'>=</span> <span class='fl'>2</span>,
  <span class='kw'>cpus_per_node</span> <span class='kw'>=</span> <span class='fl'>2</span>,
  <span class='kw'>preschedule_cores</span> <span class='kw'>=</span> <span class='fl'>TRUE</span>,
  <span class='kw'>global_objects</span> <span class='kw'>=</span> <span class='kw'>NULL</span>,
  <span class='kw'>add_objects</span> <span class='kw'>=</span> <span class='kw'>NULL</span>,
  <span class='kw'>pkgs</span> <span class='kw'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/rev.html'>rev</a></span>(<span class='fu'><a href='https://rdrr.io/r/base/zpackages.html'>.packages</a></span>()),
  <span class='kw'>libPaths</span> <span class='kw'>=</span> <span class='kw'>NULL</span>,
  <span class='kw'>rscript_path</span> <span class='kw'>=</span> <span class='kw'>NULL</span>,
  <span class='kw'>r_template</span> <span class='kw'>=</span> <span class='kw'>NULL</span>,
  <span class='kw'>sh_template</span> <span class='kw'>=</span> <span class='kw'>NULL</span>,
  <span class='kw'>slurm_options</span> <span class='kw'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span>(),
  <span class='kw'>submit</span> <span class='kw'>=</span> <span class='fl'>TRUE</span>
)</pre>

    <h2 class="hasAnchor" id="arguments"><a class="anchor" href="#arguments"></a>Arguments</h2>
    <table class="ref-arguments">
    <colgroup><col class="name" /><col class="desc" /></colgroup>
    <tr>
      <th>f</th>
      <td><p>A function that accepts one or many single values as parameters and
may return any type of R object.</p></td>
    </tr>
    <tr>
      <th>params</th>
      <td><p>A data frame of parameter values to apply <code>f</code> to. Each
column corresponds to a parameter of <code>f</code> (<em>Note</em>: names must
match) and each row corresponds to a separate function call.</p></td>
    </tr>
    <tr>
      <th>...</th>
      <td><p>Additional arguments to <code>f</code>. These arguments do not vary
with each call to <code>f</code>.</p></td>
    </tr>
    <tr>
      <th>jobname</th>
      <td><p>The name of the Slurm job; if <code>NA</code>, it is assigned a
random name of the form "slr####".</p></td>
    </tr>
    <tr>
      <th>nodes</th>
      <td><p>The (maximum) number of cluster nodes to spread the calculation
over. <code>slurm_apply</code> automatically divides <code>params</code> in chunks of
approximately equal size to send to each node. Less nodes are allocated if
the parameter set is too small to use all CPUs on the requested nodes.</p></td>
    </tr>
    <tr>
      <th>cpus_per_node</th>
      <td><p>The number of CPUs requested per node, i.e., how many
processes to run in parallel per node. This argument is mapped to the
Slurm parameter <code>cpus-per-task</code>.</p></td>
    </tr>
    <tr>
      <th>preschedule_cores</th>
      <td><p>Corresponds to the <code>mc.preschedule</code> argument of 
<code><a href='https://rdrr.io/r/parallel/mclapply.html'>parallel::mcmapply</a></code>. Defaults to <code>TRUE</code>. If <code>TRUE</code>, the 
rows of <code>params</code> are assigned to cores before computation. If <code>FALSE</code>, 
each row of <code>params</code> is executed by the next available core.
Setting <code>FALSE</code> may be faster if 
different values of <code>params</code> result in very variable completion time for
jobs.</p></td>
    </tr>
    <tr>
      <th>global_objects</th>
      <td><p>A character vector containing the name of R objects to be
saved in a .RData file and loaded on each cluster node prior to calling
<code>f</code>.</p></td>
    </tr>
    <tr>
      <th>add_objects</th>
      <td><p>Older deprecated name of <code>global_objects</code>, retained for
backwards compatibility.</p></td>
    </tr>
    <tr>
      <th>pkgs</th>
      <td><p>A character vector containing the names of packages that must
be loaded on each cluster node. By default, it includes all packages
loaded by the user when <code>slurm_apply</code> is called.</p></td>
    </tr>
    <tr>
      <th>libPaths</th>
      <td><p>A character vector describing the location of additional R
library trees to search through, or NULL. The default value of NULL
corresponds to libraries returned by <code><a href='https://rdrr.io/r/base/libPaths.html'>.libPaths()</a></code> on a cluster node.
Non-existent library trees are silently ignored.</p></td>
    </tr>
    <tr>
      <th>rscript_path</th>
      <td><p>The location of the Rscript command. If not specified, 
defaults to the location of Rscript within the R installation being run.</p></td>
    </tr>
    <tr>
      <th>r_template</th>
      <td><p>The path to the template file for the R script run on each node. 
If NULL, uses the default template "rslurm/templates/slurm_run_R.txt".</p></td>
    </tr>
    <tr>
      <th>sh_template</th>
      <td><p>The path to the template file for the sbatch submission script. 
If NULL, uses the default template "rslurm/templates/submit_sh.txt".</p></td>
    </tr>
    <tr>
      <th>slurm_options</th>
      <td><p>A named list of options recognized by <code>sbatch</code>; see
Details below for more information.</p></td>
    </tr>
    <tr>
      <th>submit</th>
      <td><p>Whether or not to submit the job to the cluster with
<code>sbatch</code>; see Details below for more information.</p></td>
    </tr>
    </table>

    <h2 class="hasAnchor" id="value"><a class="anchor" href="#value"></a>Value</h2>

    <p>A <code>slurm_job</code> object containing the <code>jobname</code> and the
  number of <code>nodes</code> effectively used.</p>
    <h2 class="hasAnchor" id="details"><a class="anchor" href="#details"></a>Details</h2>

    <p>This function creates a temporary folder ("_rslurm_[jobname]") in the current
directory, holding .RData and .RDS data files, the R script to run and the Bash
submission script generated for the Slurm job.</p>
<p>The set of input parameters is divided in equal chunks sent to each node, and
<code>f</code> is evaluated in parallel within each node using functions from the
<code>parallel</code> R package. The names of any other R objects (besides
<code>params</code>) that <code>f</code> needs to access should be included in
<code>global_objects</code> or passed as additional arguments through <code>...</code>.</p>
<p>Use <code>slurm_options</code> to set any option recognized by <code>sbatch</code>, e.g.
<code>slurm_options = list(time = "1:00:00", share = TRUE)</code>.
See <a href='http://slurm.schedmd.com/sbatch.html'>http://slurm.schedmd.com/sbatch.html</a> for details on possible options.
Note that full names must be used (e.g. "time" rather than "t") and that flags
(such as "share") must be specified as TRUE. The "array", "job-name", "nodes", 
"cpus-per-task" and "output" options are already determined by 
<code>slurm_apply</code> and should not be manually set.</p>
<p>When processing the computation job, the Slurm cluster will output two types
of files in the temporary folder: those containing the return values of the
function for each subset of parameters ("results_[node_id].RDS") and those
containing any console or error output produced by R on each node
("slurm_[node_id].out").</p>
<p>If <code>submit = TRUE</code>, the job is sent to the cluster and a confirmation
message (or error) is output to the console. If <code>submit = FALSE</code>,
a message indicates the location of the saved data and script files; the
job can be submitted manually by running the shell command
<code>sbatch submit.sh</code> from that directory.</p>
<p>After sending the job to the Slurm cluster, <code>slurm_apply</code> returns a
<code>slurm_job</code> object which can be used to cancel the job, get the job
status or output, and delete the temporary files associated with it. See
the description of the related functions for more details.</p>
    <h2 class="hasAnchor" id="see-also"><a class="anchor" href="#see-also"></a>See also</h2>

    <div class='dont-index'><p><code><a href='slurm_call.html'>slurm_call</a></code> to evaluate a single function call.</p>
<p><code><a href='slurm_map.html'>slurm_map</a></code> to evaluate a function over a list.</p>
<p><code><a href='cancel_slurm.html'>cancel_slurm</a></code>, <code><a href='cleanup_files.html'>cleanup_files</a></code>,
  <code><a href='get_slurm_out.html'>get_slurm_out</a></code> and <code><a href='get_job_status.html'>get_job_status</a></code>
  which use the output of this function.</p></div>

    <h2 class="hasAnchor" id="examples"><a class="anchor" href="#examples"></a>Examples</h2>
    <pre class="examples"><div class='input'><span class='kw'>if</span> (<span class='fl'>FALSE</span>) {
<span class='no'>sjob</span> <span class='kw'>&lt;-</span> <span class='fu'>slurm_apply</span>(<span class='no'>func</span>, <span class='no'>pars</span>)
<span class='fu'><a href='get_job_status.html'>get_job_status</a></span>(<span class='no'>sjob</span>) <span class='co'># Prints console/error output once job is completed.</span>
<span class='no'>func_result</span> <span class='kw'>&lt;-</span> <span class='fu'><a href='get_slurm_out.html'>get_slurm_out</a></span>(<span class='no'>sjob</span>, <span class='st'>"table"</span>) <span class='co'># Loads output data into R.</span>
<span class='fu'><a href='cleanup_files.html'>cleanup_files</a></span>(<span class='no'>sjob</span>)
}</div></pre>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top">
      <h2 data-toc-skip>Contents</h2>
    </nav>
  </div>
</div>


      <footer>
      <div class="copyright">
  <p>Developed by Philippe Marchand, Ian Carroll, Mike Smorul, Rachael Blake, Quentin Read.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
   </div>

  


  </body>
</html>


